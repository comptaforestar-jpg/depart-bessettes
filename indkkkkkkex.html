<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Je pars de Bessettes ‚Äî Checklist</title>
  <style>
    :root{
      --bg:#f4f6fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --accent:#7c3aed; --danger:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: var(--bg);
      color:var(--text);
      padding: 18px;
    }
    .wrap{max-width:860px; margin:0 auto;}
    h1{margin:0 0 10px 0}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
    }
    .addrow{display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;}
    input[type=text]{flex:1; min-width:220px; padding:10px; border-radius:12px; border:1px solid var(--line);}
    input[type=file]{border:1px dashed var(--line); padding:6px; border-radius:12px; min-width:220px;}
    button{
      padding:10px 14px; border-radius:12px; border:none; background:var(--accent); color:white;
      cursor:pointer; font-weight:700;
    }
    button.secondary{background:#111827;}
    button.danger{background:var(--danger);}
    .task{display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid var(--line);}
    .task.done{opacity:.55; text-decoration:line-through;}
    img{width:48px; height:48px; object-fit:cover; border-radius:8px;}
    .bar{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; align-items:center; justify-content:space-between;}
    .small{color:var(--muted); font-size:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üß≥ Je pars de Bessettes</h1>

    <div class="card">
      <div class="addrow">
        <input id="text" type="text" placeholder="Nouvelle t√¢che" />
        <input id="photo" type="file" accept="image/*" />
        <button onclick="addTask()">Ajouter</button>
      </div>

      <div id="list"></div>

      <div class="bar">
        <div class="small" id="counter">‚Äî</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="secondary" onclick="sendRecapViaFormspree()">üì© Envoyer le r√©cap</button>
          <button class="danger" onclick="clearAll()">üß® Tout effacer</button>
        </div>
      </div>
    </div>
  </div>

<script>
// ====== Donn√©es ======
let tasks = JSON.parse(localStorage.getItem('bessettes')||'[]');

function save(){ localStorage.setItem('bessettes', JSON.stringify(tasks)); }

// ====== UI ======
function render(){
  const list = document.getElementById('list');
  list.innerHTML = '';

  // non coch√©es en haut
  tasks.sort((a,b)=>a.done-b.done);

  tasks.forEach((t,i)=>{
    const d = document.createElement('div');
    d.className = 'task' + (t.done ? ' done' : '');
    d.innerHTML =
      '<input type="checkbox" ' + (t.done ? 'checked' : '') + ' onchange="toggle(' + i + ')">' +
      (t.img ? '<img src="' + t.img + '" alt="photo t√¢che">' : '') +
      '<span style="flex:1;">' + escapeHtml(t.text) + '</span>' +
      '<button style="background:#111827;" onclick="del(' + i + ')">‚ùå</button>';
    list.appendChild(d);
  });

  const done = tasks.filter(t=>t.done).length;
  const total = tasks.length;
  const left = total - done;
  document.getElementById('counter').textContent = left + ' √† faire ‚Ä¢ ' + done + ' faits ‚Ä¢ ' + total + ' total';

  save();
}

// Petit escape pour √©viter d'injecter du HTML via le champ texte
function escapeHtml(str) {
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

// ====== Actions ======
function addTask(){
  const text = document.getElementById('text').value.trim();
  const file = document.getElementById('photo').files[0];
  if(!text) return;

  if(file){
    const r = new FileReader();
    r.onload = ()=>{ tasks.push({text:text, done:false, img:r.result}); save(); render(); };
    r.readAsDataURL(file);
  }else{
    tasks.push({text:text, done:false}); save(); render();
  }
  document.getElementById('text').value = '';
  document.getElementById('photo').value = '';
}

function toggle(i){ tasks[i].done = !tasks[i].done; save(); render(); }
function del(i){ tasks.splice(i,1); save(); render(); }
function clearAll(){
  if(confirm('Tout effacer ?')){
    tasks = [];
    save();
    render();
  }
}

// ====== R√©cap + Envoi Formspree ======
function buildRecap() {
  const todo = tasks.filter(t => !t.done).map(t => "‚¨ú " + t.text);
  const done = tasks.filter(t => t.done).map(t => "‚úÖ " + t.text);

  let body = "Checklist ‚Äî Je pars de Bessettes\n\n";
  body += "√Ä faire (" + todo.length + ")\n" + (todo.length ? todo.join("\n") : "‚Äî") + "\n\n";
  body += "Fait (" + done.length + ")\n" + (done.length ? done.join("\n") : "‚Äî") + "\n\n";
  body += "G√©n√©r√© le : " + new Date().toLocaleString("fr-BE") + "\n";
  return body;
}

async function sendRecapViaFormspree(){
  const ENDPOINT = "https://formspree.io/f/xojvjwrn";
  const recap = buildRecap();

  const payload = {
    subject: "Checklist ‚Äî Je pars de Bessettes",
    message: recap,
    source: "Checklist Bessettes"
  };

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify(payload)
    });

    if(res.ok){
      alert("R√©cap envoy√© ‚úÖ (Formspree)");
    } else {
      const txt = await res.text().catch(()=> "");
      alert("Erreur d'envoi ‚ùå\n" + txt);
    }
  } catch (e) {
    alert("Erreur r√©seau ‚ùå\n" + (e && e.message ? e.message : e));
  }
}

// Entr√©e clavier
document.getElementById('text').addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') addTask();
});

render();
</script>
</body>
</html>
